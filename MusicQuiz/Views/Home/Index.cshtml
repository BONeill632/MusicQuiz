@model MusicQuiz.Web.Models.Home.MusicQuizViewModel
@using Microsoft.AspNetCore.Identity
@using MusicQuiz.Application.Services
@using MusicQuiz.Core.Entities
@inject SignInManager<UserData> SignInManager
@inject UserManager<UserData> UserManager
@inject UserExpService UserExpService
@{
    ViewData["Title"] = "Home Page";
}

<div class="container">
    @if (User.Identity?.IsAuthenticated == true)
    {
        var user = UserManager.GetUserAsync(User).Result;
        var userName = user?.FirstName ?? "User";

        <div class="jumbotron text-center">
            <h1 class="display-4">Welcome back, @userName!</h1>
            <p class="lead">Ready for your next challenge?</p>
            <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Quiz" asp-action="Index">Try a Quiz</a>
        </div>

        <div class="row my-4">
            <div class="col-md-6 d-flex flex-column justify-content-center align-items-center">
                <h2 class="text-center">Your Progress</h2>
                @if (user != null)
                {
                    var progressData = UserExpService.CalculateExpProgress(user);
                    var isMaxLevel = (user.GetLevel() == 5);
                    var progressText = isMaxLevel
                    ? $"{user.EXP}EXP"
                    : $"{progressData.expProgress}/{progressData.expNeeded}EXP";

                    <div class="progress-container-lg d-flex flex-column align-items-center text-center">
                        <div class="circular-progress-lg"
                             style="--progress:@progressData.progressPercentage; --fill-color:@(isMaxLevel ? "#8B6914" : "#002E9E")">
                            <span class="level-text-lg @(isMaxLevel ? "gold" : "")">@user.GetLevel()</span>
                        </div>
                        <span class="progress-text mt-2"><strong>@progressText!</strong></span>
                        @if (isMaxLevel)
                        {
                            <p>You've reached max level!</p>
                        }
                        else
                        {
                            <p>Keep going, you're almost there!</p>
                        }
                    </div>
                }
                else
                {
                    <p class="text-center text-danger">Unable to load user progress.</p>
                }
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-center align-items-center">
                <h2 class="text-center">Your Last Quiz Attempt</h2>
                @if (Model != null && Model.LatestAttemptDate.HasValue)
                {
                    <p class="text-center">
                        Last attempt: @Model.LatestAttemptDate.Value.ToString("dd MMM yyyy") at @Model.LatestAttemptDate.Value.ToString("hh:mm tt").
                    </p>
                    <p class="text-center">Your score: @Model.LatestUserScore.GetValueOrDefault().ToString("F2")%</p>
                    <div class="text-center">
                        <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Quiz" asp-action="Index">Try again!</a>
                    </div>
                }
                else
                {
                    <h3 class="text-center text-red-bold">OOPS!</h3>
                    <p class="text-center">No quiz attempts yet? Start now!</p>
                    <div class="text-center">
                        <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Quiz" asp-action="Index">Try a Quiz</a>
                    </div>
                }
            </div>
        </div>

        <div class="row my-4 text-center">
            <div class="col d-flex flex-column justify-content-center align-items-center">
                <h2>Compare with Friends</h2>
                <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Leaderboards" asp-action="Index">View Leaderboards</a>
            </div>
        </div>
    }
    else
    {
        <div class="jumbotron text-center">
            <h1 class="display-4">Can you reach the top?</h1>
            <p class="lead">Test your skills and see how far you can go!</p>
            <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Quiz" asp-action="Index">Try a Quiz</a>
        </div>

        <div class="row my-4">
            <div class="col-md-6 d-flex justify-content-center align-items-center">
                <img src="~/img/LevelHomepage.png" class="img-fluid" alt="Max Quiz Level" style="max-height: 350px; object-fit: contain;"> <!-- Adjusted image size -->
            </div>
            <div class="col-md-6 d-flex flex-column justify-content-center align-items-center">
                <h3 class="text-center">Test your music knowledge</h3>
                <p class="text-center">
                    Test your music knowledge with fun quizzes! Progress through levels as you hone your skills.
                </p>
            </div>
        </div>

        <div class="row my-4">
            <div class="col-md-6 order-md-2 d-flex justify-content-center align-items-center">
                <img src="~/img/HomeImage2.png" class="img-fluid" alt="Quiz Image 2" style="max-height: 350px; object-fit: contain;"> <!-- Adjusted image size -->
            </div>
            <div class="col-md-6 order-md-1 d-flex flex-column justify-content-center align-items-center">
                <h3 class="text-center">Track your progress</h3>
                <p class="text-center">
                    Create an account to track your progress, compete with friends, and unlock more levels.
                </p>
            </div>
        </div>

        <div class="row my-4 text-center">
            <div class="col d-flex flex-column justify-content-center align-items-center">
                <h2>Not sure yet?</h2>
                <p>Try a quiz with no strings attached to see what we offer!</p>
                <a class="btn btn-danger btn-lg" asp-area="" asp-controller="Quiz" asp-action="Index">Try a Quiz</a>
            </div>
        </div>
    }
</div>
