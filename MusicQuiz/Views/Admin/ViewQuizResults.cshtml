@{
    ViewData["Title"] = "Assessment Results";
}

<h1>@ViewData["Title"]</h1>
<hr />
<p class="text-center">View and analyze student assessment results.</p>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Back Button -->
<div class="text-center mb-4">
    <a href="javascript:history.back()" class="btn btn-secondary">Back</a>
</div>

<!-- Filter Form -->
<form asp-action="ViewAssessmentResults" method="get" class="text-center mb-4">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="academicYearFilter">Academic Year:</label>
                <select id="academicYearFilter" name="academicYearFilter" class="form-control form-select" autocomplete="off">
                    <option value="">All Years</option>
                    @foreach (var year in ViewBag.AcademicYears ?? new List<string>())
                    {
                        <option value="@year" selected="@(ViewBag.SelectedYear == year)">@year</option>
                    }
                </select>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label for="topicFilter">Topic:</label>
                <select id="topicFilter" name="topicFilter" class="form-control form-select" autocomplete="off">
                    <option value="">All Topics</option>
                    @foreach (var topic in Enum.GetValues(typeof(MusicQuiz.Core.Enums.Topic)))
                    {
                        <option value="@((int)topic)" selected="@(ViewBag.SelectedTopic != null && (int)ViewBag.SelectedTopic == (int)topic)">@topic</option>
                    }
                </select>
            </div>
        </div>

        <div class="col-md-4">
            <div class="form-group">
                <label for="studentFilter">Student:</label>
                <select id="studentFilter" name="studentFilter" class="form-control form-select" autocomplete="off">
                    <option value="">All Students</option>
                    @foreach (var student in ViewBag.Students ?? new List<object>())
                    {
                        <option value="@student.Id" selected="@(ViewBag.SelectedStudent == student.Id)">@student.FullName</option>
                    }
                </select>
            </div>
        </div>
    </div>

    <input type="hidden" name="pageNumber" value="1" />
    <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />

    <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
</form>

<!-- Statistics Panel -->
<div class="mt-4 mb-4">
    <h3 class="text-center">Assessment Statistics</h3>
    <div class="row text-center">
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Assessments</h5>
                    <p class="card-text display-6">@ViewBag.TotalAssessments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title">Average Score</h5>
                    <p class="card-text display-6">@(ViewBag.AverageScore?.ToString("0.00") ?? "N/A")%</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title">Highest Score</h5>
                    <p class="card-text display-6">@(ViewBag.HighestScore?.ToString("0.00") ?? "N/A")%</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h5 class="card-title">Pass Rate</h5>
                    <p class="card-text display-6">@(ViewBag.PassRate?.ToString("0.00") ?? "N/A")%</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Inputs for Chart Data -->
<input type="hidden" id="scoreData" value='@Html.Raw(Json.Serialize(ViewBag.ScoreData))' />
<input type="hidden" id="userNames" value='@Html.Raw(Json.Serialize(ViewBag.UserNames))' />
<input type="hidden" id="topicColors" value='@Html.Raw(Json.Serialize(ViewBag.TopicColors))' />

<!-- Add JS for Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    let scoreChart;

    function renderCharts() {
        const scoreData = JSON.parse(document.getElementById('scoreData').value);
        const userNames = JSON.parse(document.getElementById('userNames').value);
        const barColors = JSON.parse(document.getElementById('topicColors').value);

        // Create Score Distribution Chart
        if (scoreData.length > 0) {
            const ctxScore = document.getElementById("scoreChart").getContext("2d");
            scoreChart = new Chart(ctxScore, {
                type: "bar",
                data: {
                    labels: userNames,
                    datasets: [{
                        label: "Score (%)",
                        data: scoreData,
                        backgroundColor: barColors
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        } else {
            document.getElementById("chartContainer").innerHTML = "<p class='text-center'>No data available for chart</p>";
        }
    }

    // Render charts when page loads
    document.addEventListener("DOMContentLoaded", function () {
        renderCharts();
    });
</script>

<!-- Create placeholders for the charts -->
<div id="chartContainer" class="mt-4">
    <h2 class="text-center">Assessment Score Distribution</h2>
    <canvas id="scoreChart" width="400" height="200"></canvas>
</div>

<!-- Topic Color Legend -->
@if (ViewBag.TopicColorMap != null && ViewBag.TopicColorMap.Count > 0)
{
    <div class="d-flex justify-content-center mt-3 flex-wrap">
        @foreach (var topic in ViewBag.TopicColorMap)
        {
            <div class="d-flex align-items-center mx-3 mb-2">
                <div style="width: 20px; height: 20px; background-color: @topic.Value; margin-right: 5px; border-radius: 3px;"></div>
                <span>@topic.Key</span>
            </div>
        }
    </div>
}

<!-- Results Section -->
<div id="assessmentResults">
    <h3 class="text-center mt-4">Assessment Results</h3>

    <!-- Pagination Controls -->
    @if (ViewBag.TotalPages > 1)
    {
        <div id="resultsPagination">
            <div class="d-flex justify-content-center">
                <div class="pagination">
                    @if (ViewBag.PageNumber > 1)
                    {
                        <a asp-action="ViewAssessmentResults"
                           asp-route-pageNumber="@(ViewBag.PageNumber - 1)"
                           asp-route-pageSize="@ViewBag.PageSize"
                           asp-route-academicYearFilter="@ViewBag.SelectedYear"
                           asp-route-topicFilter="@ViewBag.SelectedTopic"
                           asp-route-studentFilter="@ViewBag.SelectedStudent"
                           class="btn btn-outline-secondary btn-sm me-2">Previous</a>
                    }
                    <span class="mx-2">Page @ViewBag.PageNumber of @ViewBag.TotalPages</span>
                    @if (ViewBag.PageNumber < ViewBag.TotalPages)
                    {
                        <a asp-action="ViewAssessmentResults"
                           asp-route-pageNumber="@(ViewBag.PageNumber + 1)"
                           asp-route-pageSize="@ViewBag.PageSize"
                           asp-route-academicYearFilter="@ViewBag.SelectedYear"
                           asp-route-topicFilter="@ViewBag.SelectedTopic"
                           asp-route-studentFilter="@ViewBag.SelectedStudent"
                           class="btn btn-outline-secondary btn-sm ms-2">Next</a>
                    }
                </div>
            </div>
        </div>
    }

    @if (ViewBag.AllResults != null && ((List<MusicQuiz.Web.Models.Admin.AssessmentResultModel>)ViewBag.AllResults).Any())
    {
        <div class="table-responsive mt-3">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Student</th>
                        <th>Score</th>
                        <th>Date</th>
                        <th>Topic</th>
                        <th>Academic Year</th>
                        <th>Assessment ID</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var result in ViewBag.AllResults)
                    {
                        string scoreClass = result.UserScore >= 80 ? "table-success" : result.UserScore >= 50 ? "table-warning" : "table-danger";
                        <tr class="@scoreClass">
                            <td>@result.Forename @result.Surname</td>
                            <td>@result.UserScore.ToString("0.00")%</td>
                            <td>@result.DateOfSubmission.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>@result.SelectedTopic</td>
                            <td>@result.AcademicYear</td>
                            <td>@result.AssessmentId</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info mt-4 text-center">
            <i class="bi bi-info-circle me-2"></i> No assessment results available for the selected filters.
        </div>
    }
</div>
